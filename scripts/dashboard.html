<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NYC Taxi Analytics Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, sans-serif; background: #1a1a2e; color: #eee; padding: 20px; }
        .header { text-align: center; margin-bottom: 30px; }
        .header h1 { color: #f39c12; font-size: 2.5em; }
        .header p { color: #888; }
        .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .card { background: #16213e; border-radius: 15px; padding: 25px; text-align: center; }
        .card h3 { color: #888; font-size: 0.9em; margin-bottom: 10px; }
        .card .value { font-size: 2.5em; font-weight: bold; color: #f39c12; }
        .card .unit { font-size: 0.8em; color: #666; }
        .chart-container { background: #16213e; border-radius: 15px; padding: 20px; margin-bottom: 20px; }
        .chart-container h2 { color: #f39c12; margin-bottom: 15px; font-size: 1.2em; }
        .chart-row { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .status { text-align: center; padding: 10px; color: #27ae60; }
        .error { color: #e74c3c; }
        @media (max-width: 768px) { .chart-row { grid-template-columns: 1fr; } }
    </style>
</head>
<body>
    <div class="header">
        <h1>ðŸš• NYC Taxi Analytics</h1>
        <p>Real-time Dashboard</p>
        <div class="status" id="status">Connecting...</div>
    </div>

    <div class="grid" id="kpis">
        <div class="card">
            <h3>TOTAL TRIPS</h3>
            <div class="value" id="total-trips">-</div>
        </div>
        <div class="card">
            <h3>TOTAL REVENUE</h3>
            <div class="value" id="total-revenue">-</div>
            <div class="unit">USD</div>
        </div>
        <div class="card">
            <h3>AVG FARE</h3>
            <div class="value" id="avg-fare">-</div>
            <div class="unit">USD</div>
        </div>
        <div class="card">
            <h3>AVG DISTANCE</h3>
            <div class="value" id="avg-distance">-</div>
            <div class="unit">miles</div>
        </div>
    </div>

    <div class="chart-row">
        <div class="chart-container">
            <h2>ðŸ“Š Trips by Hour</h2>
            <canvas id="hourlyChart"></canvas>
        </div>
        <div class="chart-container">
            <h2>ðŸ’³ Payment Types</h2>
            <canvas id="paymentChart"></canvas>
        </div>
    </div>

    <div class="chart-container">
        <h2>ðŸ“ˆ Revenue Over Time</h2>
        <canvas id="timeseriesChart"></canvas>
    </div>

    <script>
        const API_URL = 'http://localhost:5000/api';
        
        async function fetchData(endpoint) {
            try {
                const response = await fetch(`${API_URL}/${endpoint}`);
                return await response.json();
            } catch (error) {
                console.error(`Error fetching ${endpoint}:`, error);
                return null;
            }
        }

        async function updateDashboard() {
            document.getElementById('status').textContent = 'Updating...';
            
            // Fetch summary
            const summary = await fetchData('summary');
            if (summary) {
                document.getElementById('total-trips').textContent = summary.total_trips.toLocaleString();
                document.getElementById('total-revenue').textContent = '$' + summary.total_revenue.toLocaleString();
                document.getElementById('avg-fare').textContent = '$' + summary.avg_fare.toFixed(2);
                document.getElementById('avg-distance').textContent = summary.avg_distance.toFixed(1);
                document.getElementById('status').textContent = 'âœ… Live - Updated ' + new Date().toLocaleTimeString();
                document.getElementById('status').classList.remove('error');
            } else {
                document.getElementById('status').textContent = 'âŒ API Connection Error';
                document.getElementById('status').classList.add('error');
                return;
            }

            // Fetch hourly data
            const hourly = await fetchData('hourly');
            if (hourly && hourly.length > 0) {
                updateHourlyChart(hourly);
            }

            // Fetch payment data
            const payments = await fetchData('by-payment');
            if (payments && payments.length > 0) {
                updatePaymentChart(payments);
            }

            // Fetch timeseries
            const timeseries = await fetchData('timeseries');
            if (timeseries && timeseries.length > 0) {
                updateTimeseriesChart(timeseries);
            }
        }

        let hourlyChart, paymentChart, timeseriesChart;

        function updateHourlyChart(data) {
            const ctx = document.getElementById('hourlyChart').getContext('2d');
            
            if (hourlyChart) hourlyChart.destroy();
            
            hourlyChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: data.map(d => d.hour + ':00'),
                    datasets: [{
                        label: 'Trips',
                        data: data.map(d => d.trips),
                        backgroundColor: '#f39c12',
                        borderRadius: 5
                    }]
                },
                options: {
                    responsive: true,
                    plugins: { legend: { display: false } },
                    scales: {
                        y: { beginAtZero: true, grid: { color: '#333' }, ticks: { color: '#888' } },
                        x: { grid: { display: false }, ticks: { color: '#888' } }
                    }
                }
            });
        }

        function updatePaymentChart(data) {
            const ctx = document.getElementById('paymentChart').getContext('2d');
            
            if (paymentChart) paymentChart.destroy();
            
            const colors = ['#f39c12', '#3498db', '#2ecc71', '#e74c3c', '#9b59b6'];
            
            paymentChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: data.map(d => d.payment_type),
                    datasets: [{
                        data: data.map(d => d.trips),
                        backgroundColor: colors.slice(0, data.length)
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { position: 'right', labels: { color: '#888' } }
                    }
                }
            });
        }

        function updateTimeseriesChart(data) {
            const ctx = document.getElementById('timeseriesChart').getContext('2d');
            
            if (timeseriesChart) timeseriesChart.destroy();
            
            timeseriesChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: data.map(d => new Date(d.time).toLocaleString()),
                    datasets: [{
                        label: 'Revenue ($)',
                        data: data.map(d => d.revenue),
                        borderColor: '#f39c12',
                        backgroundColor: 'rgba(243, 156, 18, 0.1)',
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    plugins: { legend: { display: false } },
                    scales: {
                        y: { beginAtZero: true, grid: { color: '#333' }, ticks: { color: '#888' } },
                        x: { grid: { display: false }, ticks: { color: '#888', maxTicksLimit: 10 } }
                    }
                }
            });
        }

        // Initial load
        updateDashboard();
        
        // Refresh every 30 seconds
        setInterval(updateDashboard, 30000);
    </script>
</body>
</html>